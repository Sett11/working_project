"""
–ú–æ–¥—É–ª—å –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π Graceful Degradation.

–≠—Ç–æ—Ç —Ñ–∞–π–ª –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞:
- –ó–∞–≥—Ä—É–∑–∫—É –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env —Ñ–∞–π–ª–∞.
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ URL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (—Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –¥–ª—è Docker).
- –°–æ–∑–¥–∞–Ω–∏–µ –¥–≤–∏–∂–∫–∞ (engine) SQLAlchemy –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ë–î.
- –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–±—Ä–∏–∫–∏ —Å–µ—Å—Å–∏–π (SessionLocal) –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏.
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞ –¥–ª—è –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π (Base).
- –§—É–Ω–∫—Ü–∏—é-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä `get_session` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö FastAPI.
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Circuit Breaker –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤.
- Graceful Degradation –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –ë–î.
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ë–î —Å fallback –º–µ—Ö–∞–Ω–∏–∑–º–∞–º–∏.
"""
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession, async_sessionmaker
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.exc import InterfaceError, OperationalError, DBAPIError
from sqlalchemy import text
import asyncpg
import asyncio
import os
import time
from dotenv import load_dotenv
from utils.mylogger import Logger
from utils.graceful_degradation import (
    db_circuit_breaker, 
    CircuitBreakerOpenError,
    graceful_manager,
    fallback_manager
)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–≥–µ—Ä–∞ –¥–ª—è —Å–æ–±—ã—Ç–∏–π, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.
# log_file —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ –ø–∞–ø–∫–∏ logs, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ª–æ–≥–æ–≤.
logger = Logger(name=__name__, log_file="db.log")

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env.
# –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç –∫–æ–¥–∞.
load_dotenv()
logger.info("–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã.")

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
# –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–¥–∞–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π DATABASE_URL, –∫–æ—Ç–æ—Ä–∞—è –æ–±—ã—á–Ω–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è
# –∏–∑ docker-compose –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.
# –ï—Å–ª–∏ –æ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è DATABASE_URL_LOCAL –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.
DATABASE_URL = os.getenv("DATABASE_URL") or os.getenv("DATABASE_URL_LOCAL")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ URL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –æ–ø—Ä–µ–¥–µ–ª–µ–Ω.
if not DATABASE_URL:
    logger.error("–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î (DATABASE_URL –∏–ª–∏ DATABASE_URL_LOCAL) –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
    raise ValueError("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å DATABASE_URL –∏–ª–∏ DATABASE_URL_LOCAL –≤ .env —Ñ–∞–π–ª–µ")

logger.info(f"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è URL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {DATABASE_URL.split('@')[-1]}") # –õ–æ–≥–∏—Ä—É–µ–º –±–µ–∑ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä
detected_scheme = DATABASE_URL.split("://")[0] if "://" in DATABASE_URL else "unknown"
if not DATABASE_URL.startswith(("postgresql+asyncpg://", "postgres+asyncpg://")):
    logger.warning(
        f"‚ö†Ô∏è DATABASE_URL –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä. "
        f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Å—Ö–µ–º–∞: '{detected_scheme}'. "
        f"–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 'postgresql+asyncpg://' –∏–ª–∏ 'postgres+asyncpg://' –¥–ª—è async engine."
    )

try:
    # –°–æ–∑–¥–∞—ë–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫ SQLAlchemy –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å asyncpg
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É—Ç–µ—á–µ–∫
    engine = create_async_engine(
        DATABASE_URL, 
        echo=False, 
        future=True,
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
        pool_size=10,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤ –ø—É–ª–µ
        max_overflow=20,  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏
        pool_pre_ping=True,  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
        pool_recycle=3600,  # –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫–∞–∂–¥—ã–π —á–∞—Å
        pool_timeout=30,  # –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    )

    # –°–æ–∑–¥–∞—ë–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ–∞–±—Ä–∏–∫—É —Å–µ—Å—Å–∏–π
    AsyncSessionLocal = async_sessionmaker(
        engine, 
        expire_on_commit=False, 
        class_=AsyncSession,
        autoflush=False,  # –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π flush
        autocommit=False  # –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π commit
    )

    # –°–æ–∑–¥–∞—ë–º –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π SQLAlchemy (–æ–±—â–∏–π –¥–ª—è sync/async)
    Base = declarative_base()

    logger.info("–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ.")
except Exception as e:
    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö: {e}", exc_info=True)
    # –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ –±–µ–∑ –ë–î –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ—Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ.
    raise

async def get_session():
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å FastAPI –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
    
    –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è
    –ø—Ä–æ–±–ª–µ–º —Å generator athrow().

    Yields:
        AsyncSession: –û–±—ä–µ–∫—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏ SQLAlchemy.
        
    Raises:
        CircuitBreakerOpenError: –ï—Å–ª–∏ Circuit Breaker –æ—Ç–∫—Ä—ã—Ç
        Exception: –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö –ë–î
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ Circuit Breaker
    cb_status = db_circuit_breaker.get_status()
    if cb_status["state"] == "open":
        logger.warning("üö® Circuit Breaker –æ—Ç–∫—Ä—ã—Ç - –±–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ –ë–î")
        graceful_manager.enter_degradation_mode("Circuit Breaker –æ—Ç–∫—Ä—ã—Ç –≤ get_session")
        raise CircuitBreakerOpenError("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (Circuit Breaker –æ—Ç–∫—Ä—ã—Ç)")
    
    # –°–æ–∑–¥–∞—ë–º —Å–µ—Å—Å–∏—é –∏ –æ—Ç–¥–∞—ë–º –µ—ë
    async with AsyncSessionLocal() as session:
        session_id = id(session)
        logger.debug(f"–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö {session_id} —Å–æ–∑–¥–∞–Ω–∞.")
        
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î —á–µ—Ä–µ–∑ Circuit Breaker
            await db_circuit_breaker.acall(_test_db_connection, session)
            logger.debug(f"–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ –¥–ª—è —Å–µ—Å—Å–∏–∏ {session_id}")
        except CircuitBreakerOpenError:
            logger.error(f"üö® Circuit Breaker –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª —Å–µ—Å—Å–∏—é {session_id}")
            graceful_manager.enter_degradation_mode("Circuit Breaker –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª —Å–µ—Å—Å–∏—é")
            raise
        except Exception as test_error:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è {session_id}: {test_error}")
            graceful_manager.enter_degradation_mode(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ë–î: {test_error}")
            raise
        
        # –û—Ç–¥–∞—ë–º —Å–µ—Å—Å–∏—é
        yield session
        
        logger.debug(f"–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö {session_id} –∑–∞–∫—Ä—ã—Ç–∞.")

async def _test_db_connection(session: AsyncSession):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Circuit Breaker –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ë–î.
    
    Args:
        session: –°–µ—Å—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        
    Raises:
        Exception: –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ
    """
    try:
        await session.execute(text("SELECT 1"))
        logger.debug("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î: {e}")
        raise

async def _recreate_connection_pool_with_retry():
    """
    –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–æ–π –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏.
    
    Returns:
        tuple: (new_engine, new_session_factory) - –Ω–æ–≤—ã–π engine –∏ —Ñ–∞–±—Ä–∏–∫–∞ —Å–µ—Å—Å–∏–π
        
    Raises:
        Exception: –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –∏—Å—á–µ—Ä–ø–∞–Ω—ã
    """
    max_pool_recreation_attempts = 3
    attempt = 0
    
    while attempt < max_pool_recreation_attempts:
        attempt += 1
        logger.warning(f"üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π {attempt}/{max_pool_recreation_attempts}")
        
        try:
            new_engine, new_session_factory = await _recreate_connection_pool()
            logger.info(f"‚úÖ –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω —Å –ø–æ–ø—ã—Ç–∫–∏ {attempt}")
            return new_engine, new_session_factory  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–ø—ã—Ç–∫–∞ {attempt} –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –ø—É–ª–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å: {e}")
            
            if attempt >= max_pool_recreation_attempts:
                logger.error(f"‚ùå –ò–°–ß–ï–†–ü–ê–ù–´ –í–°–ï –ü–û–ü–´–¢–ö–ò –ü–ï–†–ï–°–û–ó–î–ê–ù–ò–Ø –ü–£–õ–ê ({max_pool_recreation_attempts}). –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞!")
                raise  # –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ø—ã—Ç–æ–∫
            
            # –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏)
            delay = min(2 ** attempt, 15)  # –ú–∞–∫—Å–∏–º—É–º 15 —Å–µ–∫—É–Ω–¥ (—É–º–µ–Ω—å—à–µ–Ω–æ —Å 30 –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏)
            logger.info(f"‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ {delay} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –ø—É–ª–∞...")
            await asyncio.sleep(delay)

async def _recreate_connection_pool():
    """
    –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö.
    
    Returns:
        tuple: (new_engine, new_session_factory) - –Ω–æ–≤—ã–π engine –∏ —Ñ–∞–±—Ä–∏–∫–∞ —Å–µ—Å—Å–∏–π
        
    Raises:
        Exception: –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –ø—É–ª–∞
    """
    global engine, AsyncSessionLocal
    try:
        logger.warning("üîÑ –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π...")
        
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π engine —Å —Ç–∞–π–º–∞—É—Ç–æ–º
        if engine:
            try:
                await engine.dispose()
                logger.info("‚úÖ –°—Ç–∞—Ä—ã–π engine —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç")
            except Exception as dispose_error:
                logger.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç–∞—Ä–æ–≥–æ engine: {dispose_error}")
        
        # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
        await asyncio.sleep(1)
        
        # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫ SQLAlchemy —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
        new_engine = create_async_engine(
            DATABASE_URL, 
            echo=False, 
            future=True,
            # –£–ª—É—á—à–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
            pool_size=10,
            max_overflow=20,
            pool_pre_ping=True,
            pool_recycle=1800,  # –£–º–µ–Ω—å—à–∞–µ–º –≤—Ä–µ–º—è —Ä–µ—Ü–∏–∫–ª–∞ –¥–æ 30 –º–∏–Ω—É—Ç
            pool_timeout=30,
            pool_reset_on_return='commit',  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ
        )

        # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ–∞–±—Ä–∏–∫—É —Å–µ—Å—Å–∏–π
        new_session_factory = async_sessionmaker(
            new_engine, 
            expire_on_commit=False, 
            class_=AsyncSession,
            autoflush=False,
            autocommit=False
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –Ω–æ–≤–æ–≥–æ –ø—É–ª–∞
        try:
            async with new_session_factory() as test_session:
                await test_session.execute(text("SELECT 1"))
            logger.info("‚úÖ –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω")
        except Exception as test_error:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—É–ª–∞: {test_error}")
            raise
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã –≤–º–µ—Å—Ç–æ –º—É—Ç–∞—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        return new_engine, new_session_factory
        
    except Exception as e:
        logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–∏ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π: {e}")
        raise

async def get_database_status():
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π Graceful Degradation.
    
    Returns:
        dict: –°—Ç–∞—Ç—É—Å –ë–î —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ Circuit Breaker –∏ Graceful Degradation
    """
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ Circuit Breaker
        cb_status = db_circuit_breaker.get_status()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ Graceful Degradation
        gd_status = graceful_manager.get_degradation_status()
        
        # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
        pool_stats = {}
        try:
            pool = engine.pool
            pool_stats = {
                "size": pool.size(),
                "checked_in": pool.checkedin(),
                "checked_out": pool.checkedout(),
                "overflow": pool.overflow(),
                "utilization_percent": (pool.checkedout() / pool.size() * 100) if pool.size() > 0 else 0
            }
        except Exception as pool_error:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—É–ª–∞: {pool_error}")
            pool_stats = {"error": str(pool_error)}
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å –ë–î
        if cb_status["state"] == "open":
            db_status = "degraded"
        elif cb_status["state"] == "half_open":
            db_status = "recovering"
        else:
            db_status = "healthy"
        
        return {
            "database_status": db_status,
            "circuit_breaker": cb_status,
            "graceful_degradation": gd_status,
            "pool_stats": pool_stats,
            "connection_url": DATABASE_URL.split('@')[-1] if DATABASE_URL else None,
            "timestamp": time.time()
        }
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ë–î: {e}")
        return {
            "database_status": "error",
            "error": str(e),
            "circuit_breaker": db_circuit_breaker.get_status(),
            "graceful_degradation": graceful_manager.get_degradation_status(),
            "pool_stats": {},
            "timestamp": time.time()
        }