<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мониторинг системы</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
/* Основные стили */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #333;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* Заголовок */
.header {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.header h1 {
    color: #2c3e50;
    font-size: 2.2rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 15px;
}

.header h1 i {
    color: #e74c3c;
    animation: heartbeat 2s infinite;
}

@keyframes heartbeat {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: 600;
    font-size: 1.1rem;
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.status-indicator.healthy .status-dot {
    background: #27ae60;
}

.status-indicator.warning .status-dot {
    background: #f39c12;
}

.status-indicator.critical .status-dot {
    background: #e74c3c;
}

.status-indicator.error .status-dot {
    background: #8e44ad;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.refresh-controls {
    display: flex;
    align-items: center;
    gap: 20px;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #2980b9, #1f618d);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
}

.auto-refresh {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    color: #2c3e50;
}

.auto-refresh input[type="checkbox"] {
    transform: scale(1.2);
}

/* Основной контент */
.main-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 25px;
}

/* Карточки */
.card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.card-header {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #ecf0f1;
}

.card-header h2 {
    color: #2c3e50;
    font-size: 1.4rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
}

.card-header i {
    color: #3498db;
}

.card-description {
    margin-top: 8px;
    font-size: 0.9rem;
    color: #7f8c8d;
    display: flex;
    align-items: center;
    gap: 8px;
}

.metric-tooltip {
    cursor: help;
    color: #95a5a6;
    font-size: 0.8rem;
    margin-left: 5px;
}

.metric-tooltip:hover {
    color: #3498db;
}

/* Системные метрики */
.metrics-grid {
    display: grid;
    gap: 20px;
}

.metric-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    transition: background 0.3s ease;
}

.metric-item:hover {
    background: #e9ecef;
}

.metric-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
}

.cpu-icon {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
}

.memory-icon {
    background: linear-gradient(135deg, #3498db, #2980b9);
}

.disk-icon {
    background: linear-gradient(135deg, #f39c12, #e67e22);
}

.network-icon {
    background: linear-gradient(135deg, #9b59b6, #8e44ad);
}

.temp-icon {
    background: linear-gradient(135deg, #e67e22, #d35400);
}

.uptime-icon {
    background: linear-gradient(135deg, #1abc9c, #16a085);
}

.metric-content {
    flex: 1;
}

.metric-label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 5px;
}

.metric-value {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 8px;
}

.metric-bar {
    width: 100%;
    height: 8px;
    background: #ecf0f1;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 5px;
}

.metric-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease, background 0.3s ease;
}

.metric-fill.healthy {
    background: linear-gradient(90deg, #27ae60, #2ecc71);
}

.metric-fill.warning {
    background: linear-gradient(90deg, #f39c12, #e67e22);
}

.metric-fill.critical {
    background: linear-gradient(90deg, #e74c3c, #c0392b);
}

.metric-detail {
    font-size: 0.9rem;
    color: #7f8c8d;
}

/* Статус строки */
.status-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
}

.status-label {
    font-weight: 600;
    color: #2c3e50;
}

.status-value {
    font-weight: 700;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
}

.status-value.healthy {
    background: #d5f4e6;
    color: #27ae60;
}

.status-value.warning {
    background: #fef5e7;
    color: #f39c12;
}

.status-value.critical {
    background: #fadbd8;
    color: #e74c3c;
}

.status-value.error {
    background: #e8daef;
    color: #8e44ad;
}

/* Пул соединений */
.pool-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
}

.pool-stat {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
}

.stat-label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #3498db;
}

/* Graceful Degradation */
.graceful-info {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
}

.graceful-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.graceful-details {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #dee2e6;
}

/* Время обновления */
.last-update {
    text-align: center;
    margin-top: 25px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    color: #7f8c8d;
    font-weight: 500;
}

.last-update i {
    margin-right: 8px;
    color: #3498db;
}

/* Индикатор загрузки */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    transition: opacity 0.3s ease;
}

.loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
}

.loading-spinner {
    text-align: center;
    color: white;
    font-size: 1.2rem;
}

.loading-spinner i {
    font-size: 3rem;
    margin-bottom: 15px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Адаптивность */
@media (max-width: 768px) {
    .container {
        padding: 15px;
    }
    
    .header-content {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .header h1 {
        font-size: 1.8rem;
    }
    
    .refresh-controls {
        flex-direction: column;
        gap: 15px;
    }
    
    .main-content {
        grid-template-columns: 1fr;
    }
    
    .metric-item {
        flex-direction: column;
        text-align: center;
    }
    
    .metric-icon {
        margin-bottom: 10px;
    }
    
    .pool-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 480px) {
    .pool-stats {
        grid-template-columns: 1fr;
    }
    
    .status-row {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }
    
    .graceful-status {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Заголовок -->
        <header class="header">
            <div class="header-content">
                <h1><i class="fas fa-heartbeat"></i> Мониторинг системы</h1>
                <div class="status-indicator" id="overall-status">
                    <span class="status-dot"></span>
                    <span class="status-text">Загрузка...</span>
                </div>
            </div>
            <div class="refresh-controls">
                <button id="refresh-btn" class="btn btn-primary">
                    <i class="fas fa-sync-alt"></i> Обновить
                </button>
                <div class="auto-refresh">
                    <label>
                        <input type="checkbox" id="auto-refresh" checked>
                        Автообновление (30 сек)
                    </label>
                </div>
            </div>
        </header>

        <!-- Основной контент -->
        <main class="main-content">
            <!-- Системная информация -->
            <section class="card system-card">
                <div class="card-header">
                    <h2><i class="fas fa-server"></i> Системные ресурсы</h2>
                    <div class="card-description">
                        <i class="fas fa-info-circle"></i>
                        Мониторинг загрузки основных компонентов сервера
                    </div>
                </div>
                <div class="card-content">
                    <div class="metrics-grid">
                        <div class="metric-item">
                            <div class="metric-icon cpu-icon">
                                <i class="fas fa-microchip"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-label">
                                    Загрузка процессора
                                    <span class="metric-tooltip" title="Процент использования CPU. Высокая загрузка может замедлить работу приложения">
                                        <i class="fas fa-question-circle"></i>
                                    </span>
                                </div>
                                <div class="metric-value" id="cpu-percent">--%</div>
                                <div class="metric-bar">
                                    <div class="metric-fill" id="cpu-bar"></div>
                                </div>
                                <div class="metric-detail" id="cpu-detail">-- ядер доступно</div>
                            </div>
                        </div>

                        <div class="metric-item">
                            <div class="metric-icon memory-icon">
                                <i class="fas fa-memory"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-label">
                                    Использование памяти
                                    <span class="metric-tooltip" title="Процент использования RAM. Критично при превышении 90%">
                                        <i class="fas fa-question-circle"></i>
                                    </span>
                                </div>
                                <div class="metric-value" id="memory-percent">--%</div>
                                <div class="metric-bar">
                                    <div class="metric-fill" id="memory-bar"></div>
                                </div>
                                <div class="metric-detail" id="memory-detail">-- МБ доступно</div>
                            </div>
                        </div>

                        <div class="metric-item">
                            <div class="metric-icon disk-icon">
                                <i class="fas fa-hdd"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-label">
                                    Использование диска
                                    <span class="metric-tooltip" title="Процент заполнения диска. Нехватка места может остановить приложение">
                                        <i class="fas fa-question-circle"></i>
                                    </span>
                                </div>
                                <div class="metric-value" id="disk-percent">--%</div>
                                <div class="metric-bar">
                                    <div class="metric-fill" id="disk-bar"></div>
                                </div>
                                <div class="metric-detail" id="disk-detail">-- ГБ свободно</div>
                            </div>
                        </div>

                        <!-- Сеть -->
                        <div class="metric-item">
                            <div class="metric-icon network-icon">
                                <i class="fas fa-network-wired"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-label">
                                    Сетевая активность
                                    <span class="metric-tooltip" title="Активность сетевых соединений. Высокая активность может указывать на проблемы">
                                        <i class="fas fa-question-circle"></i>
                                    </span>
                                </div>
                                <div class="metric-value" id="network-percent">--%</div>
                                <div class="metric-bar">
                                    <div class="metric-fill" id="network-bar"></div>
                                </div>
                                <div class="metric-detail" id="network-detail">-- соединений</div>
                            </div>
                        </div>

                        <!-- Температура -->
                        <div class="metric-item">
                            <div class="metric-icon temp-icon">
                                <i class="fas fa-thermometer-half"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-label">
                                    Температура CPU
                                    <span class="metric-tooltip" title="Температура процессора. Перегрев может вызвать сбои">
                                        <i class="fas fa-question-circle"></i>
                                    </span>
                                </div>
                                <div class="metric-value" id="temp-percent">--°C</div>
                                <div class="metric-bar">
                                    <div class="metric-fill" id="temp-bar"></div>
                                </div>
                                <div class="metric-detail" id="temp-detail">--°C максимальная</div>
                            </div>
                        </div>

                        <!-- Время работы -->
                        <div class="metric-item">
                            <div class="metric-icon uptime-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-label">
                                    Время работы
                                    <span class="metric-tooltip" title="Время непрерывной работы сервера. Длительная работа без перезагрузки - хороший знак">
                                        <i class="fas fa-question-circle"></i>
                                    </span>
                                </div>
                                <div class="metric-value" id="uptime-percent">--д</div>
                                <div class="metric-bar">
                                    <div class="metric-fill" id="uptime-bar"></div>
                                </div>
                                <div class="metric-detail" id="uptime-detail">-- часов</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- База данных -->
            <section class="card database-card">
                <div class="card-header">
                    <h2><i class="fas fa-database"></i> База данных</h2>
                    <div class="card-description">
                        <i class="fas fa-info-circle"></i>
                        Состояние подключения к базе данных PostgreSQL
                    </div>
                </div>
                <div class="card-content">
                    <div class="status-row">
                        <div class="status-label">Статус подключения:</div>
                        <div class="status-value" id="db-status">Проверка...</div>
                    </div>
                </div>
            </section>

            <!-- Пул соединений -->
            <section class="card pool-card">
                <div class="card-header">
                    <h2><i class="fas fa-network-wired"></i> Пул соединений</h2>
                    <div class="card-description">
                        <i class="fas fa-info-circle"></i>
                        Управление соединениями с базой данных для оптимизации производительности
                    </div>
                </div>
                <div class="card-content">
                    <div class="pool-stats">
                        <div class="pool-stat">
                            <div class="stat-label">Размер пула:</div>
                            <div class="stat-value" id="pool-size">--</div>
                        </div>
                        <div class="pool-stat">
                            <div class="stat-label">Активных соединений:</div>
                            <div class="stat-value" id="pool-checked-out">--</div>
                        </div>
                        <div class="pool-stat">
                            <div class="stat-label">Переполнение:</div>
                            <div class="stat-value" id="pool-overflow">--</div>
                        </div>
                        <div class="pool-stat">
                            <div class="stat-label">Утилизация:</div>
                            <div class="stat-value" id="pool-utilization">--%</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Graceful Degradation -->
            <section class="card graceful-card">
                <div class="card-header">
                    <h2><i class="fas fa-shield-alt"></i> Graceful Degradation</h2>
                    <div class="card-description">
                        <i class="fas fa-info-circle"></i>
                        Система автоматического восстановления при сбоях для обеспечения стабильности
                    </div>
                </div>
                <div class="card-content">
                    <div class="graceful-info" id="graceful-info">
                        <div class="graceful-status">
                            <div class="status-label">Режим работы:</div>
                            <div class="status-value" id="graceful-mode">Проверка...</div>
                        </div>
                        <div class="graceful-details" id="graceful-details" style="display: none;">
                            <!-- Детали будут добавлены динамически -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Время последнего обновления -->
            <div class="last-update">
                <i class="fas fa-clock"></i>
                Последнее обновление: <span id="last-update">--</span>
            </div>
        </main>
    </div>

    <!-- Индикатор загрузки -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <div>Загрузка данных...</div>
        </div>
    </div>

    <script>
// Мониторинг системы - JavaScript
class SystemMonitor {
    constructor() {
        this.autoRefreshInterval = null;
        this.isLoading = false;
        this.init();
    }

    init() {
        // Привязываем обработчики событий
        this.bindEvents();
        
        // Загружаем данные при старте
        this.loadData();
        
        // Запускаем автообновление если включено
        if (document.getElementById('auto-refresh').checked) {
            this.startAutoRefresh();
        }
    }

    bindEvents() {
        // Кнопка обновления
        document.getElementById('refresh-btn').addEventListener('click', () => {
            this.loadData();
        });

        // Чекбокс автообновления
        document.getElementById('auto-refresh').addEventListener('change', (e) => {
            if (e.target.checked) {
                this.startAutoRefresh();
            } else {
                this.stopAutoRefresh();
            }
        });
    }

    async loadData() {
        if (this.isLoading) return;
        
        this.isLoading = true;
        this.showLoading();

        try {
            const response = await fetch('/api/monitoring/status/data');
            const data = await response.json();
            
            this.updateUI(data);
            this.updateLastUpdateTime();
            
        } catch (error) {
            console.error('Ошибка загрузки данных мониторинга:', error);
            this.showError('Ошибка загрузки данных');
        } finally {
            this.isLoading = false;
            this.hideLoading();
        }
    }

    updateUI(data) {
        // Обновляем общий статус
        this.updateOverallStatus(data.overall_status);
        
        // Обновляем системные метрики
        if (data.system) {
            this.updateSystemMetrics(data.system);
        }
        
        // Обновляем статус базы данных
        this.updateDatabaseStatus(data.database_status);
        
        // Обновляем пул соединений
        if (data.pool_stats) {
            this.updatePoolStats(data.pool_stats);
        }
        
        // Обновляем graceful degradation
        if (data.graceful_degradation) {
            this.updateGracefulDegradation(data.graceful_degradation);
        }
    }

    updateOverallStatus(status) {
        const statusElement = document.getElementById('overall-status');
        const statusText = statusElement.querySelector('.status-text');
        
        // Удаляем предыдущие классы
        statusElement.className = 'status-indicator';
        
        // Добавляем новый класс и текст
        statusElement.classList.add(status);
        
        const statusLabels = {
            'healthy': 'Система работает нормально',
            'warning': 'Обнаружены предупреждения',
            'critical': 'Критические проблемы',
            'error': 'Ошибка мониторинга'
        };
        
        statusText.textContent = statusLabels[status] || 'Неизвестный статус';
    }

    updateSystemMetrics(system) {
        // Отладочная информация
        console.log('System data received:', system);
        
        // CPU
        this.updateMetric('cpu', system.cpu_percent, 'cpu-percent', 'cpu-bar');
        document.getElementById('cpu-detail').textContent = 
            `${system.cpu_count || '--'} ядер доступно`;
        
        // Память
        this.updateMetric('memory', system.memory_percent, 'memory-percent', 'memory-bar');
        document.getElementById('memory-detail').textContent = 
            `${Math.round(system.memory_available_mb)} МБ доступно`;
        
        // Диск
        this.updateMetric('disk', system.disk_usage_percent, 'disk-percent', 'disk-bar');
        document.getElementById('disk-detail').textContent = 
            `${Math.round(system.disk_free_gb || 0)} ГБ свободно`;
        
        // Сеть
        const networkPercent = system.network_usage_percent || 0;
        console.log('Network data:', { networkPercent, connections: system.network_connections });
        this.updateMetric('network', networkPercent, 'network-percent', 'network-bar');
        document.getElementById('network-detail').textContent = 
            `${system.network_connections || '--'} соединений`;
        
        // Температура
        const tempCelsius = system.cpu_temperature || 0;
        console.log('Temperature data:', { tempCelsius, maxTemp: system.cpu_temperature_max });
        this.updateMetric('temp', tempCelsius, 'temp-percent', 'temp-bar', '°C');
        document.getElementById('temp-detail').textContent = 
            `${Math.round(system.cpu_temperature_max || 0)}°C максимальная`;
        
        // Время работы
        const uptimeDays = system.uptime_days || 0;
        this.updateMetric('uptime', uptimeDays, 'uptime-percent', 'uptime-bar', 'д');
        document.getElementById('uptime-detail').textContent = 
            `${Math.round(system.uptime_hours || 0)} часов`;
    }

    updateMetric(type, value, valueId, barId, unit = '%') {
        // Обновляем значение
        document.getElementById(valueId).textContent = `${Math.round(value)}${unit}`;
        
        // Обновляем прогресс-бар
        const bar = document.getElementById(barId);
        
        // Для температуры и времени работы используем другую логику
        let barWidth = value;
        if (type === 'temp') {
            // Температура: 0-100°C -> 0-100%
            barWidth = Math.min(value, 100);
        } else if (type === 'uptime') {
            // Время работы: 0-30 дней -> 0-100%
            barWidth = Math.min((value / 30) * 100, 100);
        } else {
            // Обычные проценты
            barWidth = Math.min(value, 100);
        }
        
        bar.style.width = `${barWidth}%`;
        
        // Определяем класс в зависимости от значения
        bar.className = 'metric-fill';
        if (type === 'temp') {
            // Температура: >80°C критично, >60°C предупреждение
            if (value > 80) {
                bar.classList.add('critical');
            } else if (value > 60) {
                bar.classList.add('warning');
            } else {
                bar.classList.add('healthy');
            }
        } else if (type === 'uptime') {
            // Время работы: всегда зеленое (чем больше, тем лучше)
            bar.classList.add('healthy');
        } else {
            // Обычные метрики
            if (value > 90) {
                bar.classList.add('critical');
            } else if (value > 70) {
                bar.classList.add('warning');
            } else {
                bar.classList.add('healthy');
            }
        }
    }

    updateDatabaseStatus(status) {
        const statusElement = document.getElementById('db-status');
        statusElement.textContent = this.getDatabaseStatusText(status);
        statusElement.className = 'status-value';
        
        // Защита от null/undefined
        if (typeof status !== 'string') {
            statusElement.classList.add('critical');
            return;
        }
        
        if (status === 'healthy') {
            statusElement.classList.add('healthy');
        } else if (status.includes('timeout')) {
            statusElement.classList.add('warning');
        } else {
            statusElement.classList.add('critical');
        }
    }

    getDatabaseStatusText(status) {
        // Защита от null/undefined
        if (typeof status !== 'string') {
            return 'Неизвестное состояние';
        }
        
        if (status === 'healthy') {
            return 'Подключение активно';
        } else if (status.includes('timeout')) {
            return 'Таймаут подключения';
        } else if (status.includes('error')) {
            return 'Ошибка подключения';
        } else {
            return status;
        }
    }

    updatePoolStats(poolStats) {
        if (poolStats.error) {
            document.getElementById('pool-size').textContent = 'Ошибка';
            document.getElementById('pool-checked-out').textContent = 'Ошибка';
            document.getElementById('pool-overflow').textContent = 'Ошибка';
            document.getElementById('pool-utilization').textContent = 'Ошибка';
            return;
        }

        document.getElementById('pool-size').textContent = poolStats.size || '--';
        document.getElementById('pool-checked-out').textContent = poolStats.checked_out || '--';
        document.getElementById('pool-overflow').textContent = poolStats.overflow || '--';
        
        const utilization = poolStats.utilization_percent || 0;
        document.getElementById('pool-utilization').textContent = `${utilization}%`;
        
        // Подсвечиваем утилизацию
        const utilizationElement = document.getElementById('pool-utilization');
        if (utilization > 90) {
            utilizationElement.style.color = '#e74c3c';
        } else if (utilization > 70) {
            utilizationElement.style.color = '#f39c12';
        } else {
            utilizationElement.style.color = '#27ae60';
        }
    }

    updateGracefulDegradation(gracefulData) {
        const modeElement = document.getElementById('graceful-mode');
        const detailsElement = document.getElementById('graceful-details');
        
        if (gracefulData.error) {
            modeElement.textContent = 'Ошибка получения данных';
            modeElement.className = 'status-value error';
            return;
        }

        const isInDegradation = gracefulData.degradation_mode || false;
        
        if (isInDegradation) {
            modeElement.textContent = 'Режим graceful degradation';
            modeElement.className = 'status-value warning';
            
            // Показываем детали
            detailsElement.style.display = 'block';
            detailsElement.innerHTML = this.buildGracefulDetails(gracefulData);
        } else {
            modeElement.textContent = 'Нормальный режим';
            modeElement.className = 'status-value healthy';
            detailsElement.style.display = 'none';
        }
    }

    buildGracefulDetails(data) {
        let html = '<div class="graceful-detail-item">';
        html += `<strong>Длительность режима:</strong> ${Math.round(data.degradation_duration || 0)} сек<br>`;
        html += `<strong>Попытки восстановления:</strong> ${data.recovery_attempts || 0}/${data.max_recovery_attempts || 5}<br>`;
        html += `<strong>Последняя ошибка:</strong> ${data.last_error || 'Неизвестно'}`;
        html += '</div>';
        return html;
    }

    updateLastUpdateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('ru-RU');
        document.getElementById('last-update').textContent = timeString;
    }

    startAutoRefresh() {
        this.stopAutoRefresh(); // Останавливаем предыдущий интервал
        this.autoRefreshInterval = setInterval(() => {
            this.loadData();
        }, 30000); // 30 секунд
    }

    stopAutoRefresh() {
        if (this.autoRefreshInterval) {
            clearInterval(this.autoRefreshInterval);
            this.autoRefreshInterval = null;
        }
    }

    showLoading() {
        document.getElementById('loading-overlay').classList.remove('hidden');
    }

    hideLoading() {
        document.getElementById('loading-overlay').classList.add('hidden');
    }

    showError(message) {
        // Простое уведомление об ошибке
        alert(`Ошибка: ${message}`);
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
    window.systemMonitor = new SystemMonitor();
});

// Обработка видимости страницы для оптимизации автообновления
document.addEventListener('visibilitychange', () => {
    const autoRefreshCheckbox = document.getElementById('auto-refresh');
    const monitor = window.systemMonitor;
    
    if (document.hidden) {
        // Страница скрыта - останавливаем автообновление
        if (monitor && monitor.autoRefreshInterval) {
            monitor.stopAutoRefresh();
        }
    } else {
        // Страница видима - возобновляем автообновление если было включено
        if (autoRefreshCheckbox.checked) {
            if (monitor) {
                monitor.startAutoRefresh();
            }
        }
    }
});
    </script>
</body>
</html>
