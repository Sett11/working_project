#!/usr/bin/env bash

# –°–∫—Ä–∏–ø—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ seeder —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

echo "üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª-—Ñ–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π –Ω–∞ —Ç–æ, —á—Ç–æ seeder —É–∂–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω
FLAG_FILE="/app/.seeder_flag"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
wait_for_database() {
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    if ! command -v pg_isready >/dev/null 2>&1; then
        echo "‚ùå –û—à–∏–±–∫–∞: pg_isready –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ PostgreSQL –∫–ª–∏–µ–Ω—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        return 1
    fi
    
    if [ -z "$DATABASE_URL" ]; then
        echo "‚ùå –û—à–∏–±–∫–∞: DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        return 1
    fi
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π URL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
    SYNC_URL="${DATABASE_URL_SYNC:-$DATABASE_URL}"
    echo "üîç –ò—Å–ø–æ–ª—å–∑—É–µ–º URL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏: $SYNC_URL"
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –±–µ–∑ local –¥–ª—è POSIX —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    db_timeout=${DB_TIMEOUT:-60}  # –¢–∞–π–º–∞—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 60 —Å–µ–∫—É–Ω–¥
    db_interval=${DB_INTERVAL:-2}  # –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 2 —Å–µ–∫—É–Ω–¥—ã
    db_elapsed=0
    
    echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (—Ç–∞–π–º–∞—É—Ç: ${db_timeout}—Å)..."
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL –∏—Å–ø–æ–ª—å–∑—É—è DATABASE_URL"
    
    # –ü–∞—Ä—Å–∏–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π URL –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    # –§–æ—Ä–º–∞—Ç: postgresql://user:password@host:port/database
    db_host=$(echo "$SYNC_URL" | sed -n 's/.*@\([^:]*\).*/\1/p')
    db_port=$(echo "$SYNC_URL" | sed -n 's/.*:\([0-9]*\)\/.*/\1/p')
    db_name=$(echo "$SYNC_URL" | sed -n 's/.*\/\([^?]*\).*/\1/p')
    
    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    db_host=${db_host:-localhost}
    db_port=${db_port:-5432}
    db_name=${db_name:-postgres}
    
    echo "üîç –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î: $db_host:$db_port/$db_name"
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º pg_isready —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    while [ $db_elapsed -lt $db_timeout ]; do
        if pg_isready -h "$db_host" -p "$db_port" -d "$db_name" >/dev/null 2>&1; then
            echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é"
            return 0
        fi
        
        # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ psql
        if command -v psql >/dev/null 2>&1; then
            if psql "$SYNC_URL" -c "SELECT 1;" >/dev/null 2>&1; then
                echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é (–ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ psql)"
                return 0
            fi
        fi
        
        sleep $db_interval
        db_elapsed=$((db_elapsed + db_interval))
        echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ... (${db_elapsed}/${db_timeout}—Å)"
    done
    
    echo "‚ùå –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
    return 1
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–ª–∞–≥–∞
check_flag_exists() {
    if [ -f "$FLAG_FILE" ]; then
        return 0  # –§–ª–∞–≥-—Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    elif [ -d "$FLAG_FILE" ] && [ -f "$FLAG_FILE/.seeder_completed" ]; then
        return 0  # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∞—Ä–∫–µ—Ä–Ω—ã–π —Ñ–∞–π–ª
    fi
    return 1  # –§–ª–∞–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–ª–∞–≥–∞
create_flag() {
    if [ -d "$FLAG_FILE" ]; then
        # –ï—Å–ª–∏ FLAG_FILE - —ç—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è, —Å–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä–Ω—ã–π —Ñ–∞–π–ª –≤–Ω—É—Ç—Ä–∏
        touch "$FLAG_FILE/.seeder_completed"
        echo "üìù –°–æ–∑–¥–∞–Ω –º–∞—Ä–∫–µ—Ä–Ω—ã–π —Ñ–∞–π–ª: $FLAG_FILE/.seeder_completed"
    else
        # –ï—Å–ª–∏ FLAG_FILE - —ç—Ç–æ —Ñ–∞–π–ª, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
        touch "$FLAG_FILE"
        echo "üìù –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª-—Ñ–ª–∞–≥: $FLAG_FILE"
    fi
}

if ! check_flag_exists; then
    echo "üå± –ó–∞–ø—É—Å–∫ seeder –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    
    # –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    if ! wait_for_database; then
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∂–¥–∞—Ç—å—Å—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
        exit 1
    fi
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º seeder
    cd /app
    python -m db.seeder
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ Seeder —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω"
        # –°–æ–∑–¥–∞–µ–º —Ñ–ª–∞–≥
        create_flag
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ seeder"
        exit 1
    fi
else
    if [ -f "$FLAG_FILE" ]; then
        echo "‚úÖ Seeder —É–∂–µ –±—ã–ª –≤—ã–ø–æ–ª–Ω–µ–Ω —Ä–∞–Ω–µ–µ (—Ñ–∞–π–ª-—Ñ–ª–∞–≥ –Ω–∞–π–¥–µ–Ω: $FLAG_FILE)"
    else
        echo "‚úÖ Seeder —É–∂–µ –±—ã–ª –≤—ã–ø–æ–ª–Ω–µ–Ω —Ä–∞–Ω–µ–µ (–º–∞—Ä–∫–µ—Ä–Ω—ã–π —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω: $FLAG_FILE/.seeder_completed)"
    fi
fi

echo "üéâ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
