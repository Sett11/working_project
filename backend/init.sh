#!/usr/bin/env bash

# –°—Ç—Ä–æ–≥–∏–µ —Ñ–ª–∞–≥–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
# -e: –≤—ã—Ö–æ–¥ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ –∫–æ–º–∞–Ω–¥—ã
# -u: –≤—ã—Ö–æ–¥ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
# -o pipefail: –≤—ã—Ö–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤ –ª—é–±–æ–π —á–∞—Å—Ç–∏ pipeline
set -euo pipefail

# –°–∫—Ä–∏–ø—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ seeder —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

echo "üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª-—Ñ–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π –Ω–∞ —Ç–æ, —á—Ç–æ seeder —É–∂–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω
# –ü—É—Ç—å –∫ —Ñ–ª–∞–≥—É –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è SEEDER_FLAG_FILE
FLAG_FILE="${SEEDER_FLAG_FILE:-/app/.seeder_flag}"
echo "üîç –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—É—Ç—å –∫ —Ñ–ª–∞–≥—É: $FLAG_FILE"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
wait_for_database() {
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    if ! command -v pg_isready >/dev/null 2>&1; then
        echo "‚ùå –û—à–∏–±–∫–∞: pg_isready –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ PostgreSQL –∫–ª–∏–µ–Ω—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        return 1
    fi
    
    if [ -z "$DATABASE_URL" ]; then
        echo "‚ùå –û—à–∏–±–∫–∞: DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        return 1
    fi
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π URL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
    SYNC_URL="${DATABASE_URL_SYNC:-$DATABASE_URL}"
    echo "üîç –ò—Å–ø–æ–ª—å–∑—É–µ–º URL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏: $SYNC_URL"
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –±–µ–∑ local –¥–ª—è POSIX —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    db_timeout=${DB_TIMEOUT:-60}  # –¢–∞–π–º–∞—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 60 —Å–µ–∫—É–Ω–¥
    db_interval=${DB_INTERVAL:-5}  # –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 —Å–µ–∫—É–Ω–¥
    db_elapsed=0
    
    echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (—Ç–∞–π–º–∞—É—Ç: ${db_timeout}—Å)..."
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL –∏—Å–ø–æ–ª—å–∑—É—è DATABASE_URL_SYNC"
    echo "üîç URL: $SYNC_URL"
    
    # –ü–∞—Ä—Å–∏–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π URL –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    # –§–æ—Ä–º–∞—Ç: postgresql://user:password@host:port/database
    db_host=$(echo "$SYNC_URL" | sed -n 's/.*@\([^:]*\).*/\1/p')
    db_port=$(echo "$SYNC_URL" | sed -n 's/.*:\([0-9]*\)\/.*/\1/p')
    db_name=$(echo "$SYNC_URL" | sed -n 's/.*\/\([^?]*\).*/\1/p')
    
    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    db_host=${db_host:-db}
    db_port=${db_port:-5432}
    db_name=${db_name:-form_com_offer_db}
    
    echo "üîç –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î: $db_host:$db_port/$db_name"
    
    # –î–∞–µ–º –ë–î –≤—Ä–µ–º—è –Ω–∞ –ø–æ–ª–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
    echo "‚è≥ –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î..."
    sleep 15
    
    # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ psql
    while [ $db_elapsed -lt $db_timeout ]; do
        if command -v psql >/dev/null 2>&1; then
            if psql "$SYNC_URL" -c "SELECT 1;" >/dev/null 2>&1; then
                echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é"
                return 0
            fi
        fi
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ netcat (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
        if command -v nc >/dev/null 2>&1; then
            if nc -z "$db_host" "$db_port" 2>/dev/null; then
                echo "‚úÖ –ü–æ—Ä—Ç $db_port –Ω–∞ $db_host –¥–æ—Å—Ç—É–ø–µ–Ω (netcat)"
                # –ï—Å–ª–∏ –ø–æ—Ä—Ç –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ pg_isready –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–∞–µ–º –ë–î –µ—â–µ –≤—Ä–µ–º—è
                sleep 2
                continue
            fi
        fi
        
        sleep $db_interval
        db_elapsed=$((db_elapsed + db_interval))
        echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ... (${db_elapsed}/${db_timeout}—Å)"
    done
    
    echo "‚ùå –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
    return 1
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–ª–∞–≥–∞
check_flag_exists() {
    if [ -f "$FLAG_FILE" ]; then
        return 0  # –§–ª–∞–≥-—Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    fi
    
    if [ -d "$FLAG_FILE" ] && [ -f "$FLAG_FILE/.seeder_completed" ]; then
        return 0  # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∞—Ä–∫–µ—Ä–Ω—ã–π —Ñ–∞–π–ª
    fi
    
    return 1  # –§–ª–∞–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–ª–∞–≥–∞
create_flag() {
    local target_file
    
    if [ -d "$FLAG_FILE" ]; then
        # –ï—Å–ª–∏ FLAG_FILE - —ç—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è, —Å–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä–Ω—ã–π —Ñ–∞–π–ª –≤–Ω—É—Ç—Ä–∏
        target_file="$FLAG_FILE/.seeder_completed"
    else
        # –ï—Å–ª–∏ FLAG_FILE - —ç—Ç–æ —Ñ–∞–π–ª, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
        target_file="$FLAG_FILE"
    fi
    
    # –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª-—Ñ–ª–∞–≥ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏
    if ! touch "$target_file" 2>/dev/null; then
        echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª-—Ñ–ª–∞–≥ $target_file" >&2
        return 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –±—ã–ª —Å–æ–∑–¥–∞–Ω
    if [ ! -f "$target_file" ]; then
        echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª-—Ñ–ª–∞–≥ $target_file –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è" >&2
        return 1
    fi
    
    echo "üìù –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª-—Ñ–ª–∞–≥: $target_file"
    return 0
}

# –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è seeder
LOCK_FILE="${SEEDER_LOCK_FILE:-/app/.seeder.lock}"
echo "üîç –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: $LOCK_FILE"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
safe_cd() {
    local target_dir="$1"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    if [ ! -d "$target_dir" ]; then
        echo "‚ùå –û—à–∏–±–∫–∞: –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $target_dir –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" >&2
        return 1
    fi
    
    # –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    if ! cd "$target_dir" 2>/dev/null; then
        echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é $target_dir" >&2
        return 1
    fi
    
    echo "‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ—à–ª–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: $target_dir"
    return 0
}

# –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
# –§–∞–π–ª–æ–≤—ã–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä 200 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
exec 200>"$LOCK_FILE"

echo "üîí –ü–æ–ø—ã—Ç–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏..."

# –ü—ã—Ç–∞–µ–º—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É (–Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π —Ä–µ–∂–∏–º)
if ! flock -n 200; then
    echo "‚è≥ –î—Ä—É–≥–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç seeder. –û–∂–∏–¥–∞–Ω–∏–µ..."
    # –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –≤ –±–ª–æ–∫–∏—Ä—É—é—â–µ–º —Ä–µ–∂–∏–º–µ (–∂–¥–µ–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è)
    if ! flock -w 300 200; then
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –≤ —Ç–µ—á–µ–Ω–∏–µ 300 —Å–µ–∫—É–Ω–¥" >&2
        exit 1
    fi
fi

echo "‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞—Ö–≤–∞—á–µ–Ω–∞"

# –í–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ –ø–æ–≤—Ç–æ—Ä–Ω–æ (–¥—Ä—É–≥–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–æ–≥ –µ–≥–æ —Å–æ–∑–¥–∞—Ç—å)
if ! check_flag_exists; then
    echo "üå± –ó–∞–ø—É—Å–∫ seeder –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    
    # –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    if ! wait_for_database; then
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∂–¥–∞—Ç—å—Å—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö" >&2
        # –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º
        flock -u 200
        exit 1
    fi
    
    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    if ! safe_cd /app; then
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é" >&2
        # –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º
        flock -u 200
        exit 1
    fi
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º seeder
    echo "üöÄ –ó–∞–ø—É—Å–∫ python -m db.seeder..."
    if python -m db.seeder; then
        echo "‚úÖ Seeder —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω"
        
        # –°–æ–∑–¥–∞–µ–º —Ñ–ª–∞–≥ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å
        if ! create_flag; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª-—Ñ–ª–∞–≥ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è seeder" >&2
            # –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º
            flock -u 200
            exit 1
        fi
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ seeder (–∫–æ–¥ –≤—ã—Ö–æ–¥–∞: $?)" >&2
        # –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º
        flock -u 200
        exit 1
    fi
else
    if [ -f "$FLAG_FILE" ]; then
        echo "‚úÖ Seeder —É–∂–µ –±—ã–ª –≤—ã–ø–æ–ª–Ω–µ–Ω —Ä–∞–Ω–µ–µ (—Ñ–∞–π–ª-—Ñ–ª–∞–≥ –Ω–∞–π–¥–µ–Ω: $FLAG_FILE)"
    else
        echo "‚úÖ Seeder —É–∂–µ –±—ã–ª –≤—ã–ø–æ–ª–Ω–µ–Ω —Ä–∞–Ω–µ–µ (–º–∞—Ä–∫–µ—Ä–Ω—ã–π —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω: $FLAG_FILE/.seeder_completed)"
    fi
fi

# –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
echo "üîì –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏..."
flock -u 200

echo "üéâ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
